
## 局域网网络传输流程


### 局域网(以太网为例)通信原理

- 首先明确，两台主机在同一个局域网，是否能够直接通信？是的！
- 原理类似在教室上课，老师与学生之间的通信
- 每台主机在局域网上，要有唯一的标识来保证主机的唯一性：**mac地址**

### 认识MAC地址

- MAC地址用来识别数据链路层中相连的节点;
- 长度为48位,及6个字节.一般用16进制数字加上冒号的形式来表示(例如:52:54:00:04:b1:44)
- 在网卡出厂时就确定了,不能修改.
- mac地址**通常是唯一的**(虚拟机中的mac地址不是真实的mac地址,可能会冲突;也有些网卡支持用户配置mac地址).
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/64c592e4ef4b4c18b1ce3f68a79526fe.png)

![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/8fa81300cb524136a84173a31c69aa0e.png)

• 以太网中，任何时刻，**只允许一台机器向网络中发送数据**（互斥）
• 如果有多台同时发送，会发生数据干扰，我们称之为**数据碰撞**
• 所有发送数据的主机要进行**碰撞检测**和**碰撞避免**
• 没有交换机的情况下，一个以太网就是一个**碰撞域**
• 局域网通信的过程中，主机对收到的报文确认是否是发给自己的，是通过目标mac地址判定

初步明白了局域网通信原理，再来看同一个网段内的两台主机进行发送消息的过程
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/203d15c89b1044e184f145d622e6dbd4.png)
而其中每层都有协议，所以当我进行进行上述传输流程的时候，要进行**封装**和**解包**

![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/f47e84f2efac4065b6f83711583233a4.png)
注：网卡接受发送响应报文后，回向OS发送中断信号以提醒OS分发解包报文
明确概念：

- 报头部分，就是对应协议层的结构体字段，我们一般叫做**报头**，报头与报文解离并且报文内部必须包含一个字段分用（表明交给上层谁的字段）
- 除了报头，剩下的叫做有效载荷
- 故，**报文=报头+有效载荷**

然后，我们在明确一下不同层的完整报文的叫法：
- 不同的协议层对数据包有不同的称谓,在传输层叫做`段`(segment),在网络层叫做`数据报`(datagram),在链路层叫做`帧`(frame).
- 应用层数据通过协议栈发到网络上时,每层协议都要加上一个数据**首部**(header),称为封装(Encapsulation).
- 首部信息中包含了一些类似于首部有多长,载荷(payload)有多长,上层协议是什么等信息.
- 数据封装成帧后发到传输介质上,到达目的主机后每层协议再剥掉相应的首部,根据首部中的"上层协议字段"将数据交给对应的上层协议处理.

![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/55fb2665730d4404be6c06cbcfe654bc.png)
在网络传输的过程中，数据不是直接发送给对方主机的，而是先要**自顶向下将数据交付给下层协议**，最后由底层发送，然后由对方主机的底层来进行接受，再**自底向上进行向上交付**，上面是一张示意图。

## 数据包封装和分用

数据封装的过程

![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/36a077c8895841f785aab322bdff4b29.png)

数据分用的过程


![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/df428852d1484317ac43763c85d45301.png)

我们学习任何协议，都要先宏观上建立这样的认识：
1. 要学习的协议，是如何做到解包的？只有明确了解包，封包也就能理解。
2. 要学习的协议，是如何做到将自己的有效载荷，交付给上层协议的？

## 跨网络传输流程


### 认识IP地址

IP 协议有两个版本,`IPv4`和`IPv6`. 我们整个的课程,凡是提到IP协议,没有特殊说明的,默认都是指`IPv4`


 - IP地址是在IP协议中,用来标识网络中不同主机的地址;
 - 对于IPv4来说,IP地址是一个4字节,32位的整数;
 - 我们通常也使用"点分十进制"的字符串表示IP地址,例如192.168.0.1;用点分割的每一个数字表示一个字节,范围是0-255;



跨网段的主机的数据传输.数据从一台计算机到另一台计算机传输过程中要经过一个或多个路由器.


![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/46102fabc1b541b6b20ff8f885a1c7b2.png)
首先理解一下IP地址的意义：
- 为什么要去目标主机，先要走路由器？
	- 网络中的设备通过 IP 地址来标识身份。当源主机要向目标主机发送数据时，它需要知道如何将数据准确地送达目标。路由器具备路由表，其中存储了网络地址信息和对应的转发路径。路由器会根据目标 IP 地址，在路由表中查找最佳路径，然后将数据沿着该路径转发，确保数据能够准确无误地到达目标主机。 
- 目的IP的意义
	- 源主机在发送数据时，必须明确指定目的 IP 地址，这样网络中的各种设备（如路由器、交换机等）才能按照协议规定，对数据包进行正确的处理和转发。目的 IP 地址是建立网络连接、实现端到端通信的基础，没有它，数据就无法在网络中准确传输，应用程序之间的通信也就无法实现。 
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/f1bc88bdbaa84c9aa8ea30f1d2844d9e.png)
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/1ec0ce118e9d49d38bc8a3d39348a8d1.png)
对比IP地址和Mac地址的区别
- IP地址在整个路由过程中，一直不变(目前，我们只能这样说明，后面在修正)
- Mac地址一直在变
- 目的IP是一种长远目标，Mac是下一阶段目标，目的IP是路径选择的重要依据，mac地址是局域网转发的重要依据

提炼IP网络的意义和网络通信的宏观流程

![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/f67c98eb75424a00965ad0418290981c.png)
IP网络层存在的意义：提供网络虚拟层，让世界的所有网络都是IP网络，屏蔽最底层网络的差异
