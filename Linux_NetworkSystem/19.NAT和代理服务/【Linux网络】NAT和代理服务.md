## NAT
之前我们讨论了，IPv4协议中，IP地址数量不充足的问题。

原始报文途径路由器WAN口时，对报文中的源IP进行替换的过程，叫做**NAT**。

NAT技术当前解决IP地址不够用的主要手段，是路由器的一个重要功能：
- NAT能够将私有IP对外通信时转为全局IP，也就是就是一种将私有IP和全局IP相互转化的技术方法。
- 很多学校，家庭，公司内部采用每个终端设置私有IP，而在路由器或必要的服务器上设置全局IP。
- 全局IP要求唯一，但是私有IP不需要；在不同的局域网中出现相同的私有IP是完全不影响的。

### NAT IP转换过程
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/43a18dc0e8924d29a14a56b1fa32dad5.png)

- NAT路由器将源地址从10.0.0.10替换成全局的IP 202.244.174.37。
- NAT路由器收到外部的数据时，又会把目标IP从202.244.174.37替换回10.0.0.10。
- 在NAT路由器内部，有一张自动生成的，用于地址转换的表。
- 当10.0.0.10第一次向163.221.120.9发送数据时就会生成表中的映射关系。

## NAPT
首先明确一点，在我们进行NAT转换时，有可能将IP替换，也有可能将IP+PORT进行替换。


那么问题来了，如果局域网内，有多个主机都访问同一个外网服务器，那么对于服务器返回的数据中，目的IP都是相同的。那么NAT路由器如何判定将这个数据包转发给哪个局域网的主机？


这时候NAPT来解决这个问题了，使用IP+port来建立这个关联关系。

这种关联关系也是由NAT路由器自动维护的。例如在TCP的情况下，建立连接时，就会生成这个表项；在断开连接后，就会删除这个表项。
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/95011e566d1c4cbb885abddc5fcebcc7.png)





### NAT技术的缺陷
由于NAT依赖这个转换表，所以有诸多限制：
- 无法从NAT外部向内部服务器建立连接；
- 装换表的生成和销毁都需要额外开销；
- 通信过程中一旦NAT设备异常，即使存在热备，所有的TCP连接也都会断开。

## 代理服务器
### 正向代理
**概述**
正向代理（Forward Proxy）是一种常见的网络代理方式，它位于客户端和目标服务器之间，**代表客户端向目标服务器发送请求**。正向代理服务器接收客户端的请求，然后将请求转发给目标服务器，最后将目标服务器的响应返回给客户端。通过这种方式，正向代理可以实现多种功能，如提高访问速度、隐藏客户端身份、实施访问控制等。
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/d90a8696c7a9410e8615c9ce38f9ec0c.png)

**工作原理**
- 客户端将请求发送给正向代理服务器。
- 正向代理服务器接收请求，并根据配置进行处理，如缓存查找、内容过滤等。
- 正向代理服务器将处理后的请求转发给目标服务器。
- 目标服务器处理请求，并将响应返回给正向代理服务器。
- 正向代理服务器将响应返回给客户端。

**功能特点**
- 缓存功能：正向代理服务器可以缓存经常访问的资源，当客户端再次请求这些资源时，可以直接从缓存中获取，提高访问速度。
- 内容过滤：正向代理可以根据预设的规则对请求或响应进行过滤，如屏蔽广告、阻止恶意网站等。 
- 访问控制：通过正向代理，可以实现对特定网站的访问控制，如限制员工在工作时间访问娱乐网站。 
- 隐藏客户端身份：正向代理可以隐藏客户端的真实IP地址，保护客户端的隐私。 
- 负载均衡：在多个目标服务器之间分配客户端请求，提高系统的可扩展性和可靠性。 

**应用场景**
- **企业网络管理**：企业可以通过正向代理实现对员工网络访问的管理和控制，确保员工在工作时间内专注于工作，避免访问不良网站或泄露公司机密。
- **公共网络环境**：在公共场所如图书馆、学校等提供的网络环境中，通过正向代理可以实现对网络资源的合理分配和管理，确保网络使用的公平性和安全性。 
- **内容过滤与保护**：家长可以通过设置正向代理来过滤不良内容，保护孩子免受网络上的不良信息影响。 
- **提高访问速度**：对于经常访问的网站或资源，正向代理可以通过缓存机制提高访问速度，减少网络延迟。 
- **跨境电商与海外访问**：对于跨境电商或需要访问海外资源的企业和个人，正向代理可以帮助他们突破网络限制，顺畅地访问海外网站和资源。 

### 反向代理
**概述**
反向代理服务器是一种网络架构模式，其作为Web服务器的前置服务器，**接收来自客户端的请求，并将这些请求转发给后端的Web服务器**，然后将后端服务器的响应返回给客户端。这种架构模式可以提升网站性能、安全性和可维护性等。

![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/dcbc183c2f684f3a8ae5492d4592ff63.png)


**基本原理**
- 反向代理服务器位于客户端和Web服务器之间，当客户端发起请求时，它首先会到达反向代理服务器。反向代理服务器会根据配置的规则将请求转发给后端的Web服务器，并将Web服务器的响应返回给客户端。在这个过程中，客户端并不知道实际与哪一个Web服务器进行了交互，它只知道与反向代理服务器进行了通信。

**应用场景**
- **负载均衡**：反向代理服务器可以根据配置的负载均衡策略，将客户端的请求分发到多个后端服务器上，以实现负载均衡。这有助于提升网站的整体性能和响应速度，特别是在高并发场景下。 
- **安全保护**：反向代理服务器可以隐藏后端Web服务器的真实IP地址，降低其被直接攻击的风险。它还可以配置防火墙、访问控制列表（ACL）等安全策略，对客户端的请求进行过滤和限制，以保护后端服务器的安全。 
- **请求缓存加速**：反向代理服务器可以缓存后端Web服务器的响应内容，对于重复的请求，它可以直接从缓存中返回响应，而无需再次向服务器发出请求。这可以大大减轻后端服务器的负载，提升网站的响应速度。 
- **内容过滤和重写**：反向代理服务器可以根据配置的规则对客户端的请求进行过滤和重写，例如添加/删除请求头、修改请求路径等。这有助于实现一些特定的业务需求，如URL重写、认证等。 
- **动静资源分离**：在大型网站上，通常需要将静态资源和动态资源分开处理。通过将静态资源部署在反向代理服务器上，可直接从反向代理服务器向客户端提供响应，而无需再次向后端服务器发起请求。这可以大大提升静态资源的访问速度。 

- CDN（Content Delivery Network，内容分发网络）就是采用了反向代理的原理
## NAT和代理服务器
路由器**往往都具备NAT设备的功能，通过NAT设备进行中转，完成子网设备和其他子网设备的通信过程**。

代理服务器真正要求和服务器通信，服务器返回结果后，代理服务器又把结果转发给客户端。

那么NAT和代理服务器的区别有哪些呢？
- **从应用上讲**：NAT设备是网络基础设备之一，解决的是IP不足的问题。代理服务器则是更贴近具体应用，比如通过代理服务器进行翻墙，另外像迅游这样的加速器，也是使用代理服务器。
- **从底层实现上讲**：NAT是工作在网络层，直接对IP地址进行替换。代理服务器往往工作在应用层。 
- **从使用范围上讲**：NAT一般部署在局域网的出口部署。代理服务器可以在局域网做，也可以在广域网做，也可以跨网。 
- **从部署位置上看**：NAT一般集成在防火墙，路由器等硬件设备上。代理服务器则是一个软件程序，需要部署在服务器上。 

**代理服务器是一种应用比较广的技术**
- 翻墙：广域网中的代理
- 负载均衡：局域网中的代理


