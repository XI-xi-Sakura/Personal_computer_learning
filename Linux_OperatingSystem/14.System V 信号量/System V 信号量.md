# System V 信号量
信号量主要用于**同步和互斥**。

声明以下概念：
- 各个执行流能看到的同一个公共资源：**共享资源**
- 被保护起来的资源叫做**临界资源**
- 保护的方式常见：互斥与同步
    - 任何时刻，只允许一个执行流访问资源，叫做互斥
    - 各个执行流，访问临界资源的时候，具有一定的顺序性，叫做同步

系统中某些资源，一次只允许一个进程使用，称这样的资源为临界资源或互斥资源。

在进程中涉及到互斥资源的程序段叫临界区。所谓的对共享资源进行保护，本质是对访问共享资源的代码进行保护。

![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/8245efea19074a79b1aa448e981b5938.png)


## 概述
System V信号量是Linux系统中一种重要的进程间通信（IPC）机制。

主要用于协调各个进程对共享资源的访问，以避免竞争条件（多个进程同时访问和修改共享资源导致数据不一致的情况）。

信号量本质上是一个非负整数计数器，**用于记录可用资源的数量**。进程在访问共享数据之前，需要对信号量进行操作，以获取对资源的访问权。
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/a48f0aee23284b8ab06e8e66783c54b2.png)

## 相关系统调用
1. **创建或获取信号量集**
```c
int semget(key_t key, int nsems, int semflg);
```
`nsems`：表示信号量集中信号量的个数
2. **初始化信号量的值**
```c
int semctl(int semid, int semnum, int cmd,...);
```
- `semnum`是信号量集中信号量的序号
- `cmd`是要执行的命令

对于`SETVAL`命令，需要一个`union semun`类型的参数
```c
union semun {
    int val; // 用于指定信号量的初始值
    // 其他成员，用于不同的semctl命令
};
union semun arg;
arg.val = 1;
int ret = semctl(semid, 0, SETVAL, arg);
```
3. **操作信号量（P、V操作）**
```c
int semop(int semid, struct sembuf* sops, size_t nsops);
```
`sops`是一个指向`struct sembuf`结构体数组的指针，`nsops`是`sops`数组中元素的个数，即要同时进行信号量操作的个数。

下面介绍`struct sembuf`结构体成员：
  - `sem_num`：表示信号量集中信号量的序号
  - `sem_op`：定义对信号量的操作类型
    - `sem_op = -1`时，进行P操作，信号量值 -1，等待操作或获取资源操作
     - `sem_op = 1`时，进行V操作，信号量值 +1，信号操作或释放资源操作
   - **`sem_flg`**：用于指定操作信号量时的一些标志，通常设置为0，表示正常操作
4. **获取信号量集的状态信息**
同样使用`semctl`，不过`cmd`参数为`IPC_STAT`

## 信号量集的结构和属性
每个信号量集在内核中有一个对应的`struct semid_ds`结构来描述其属性。信号量集中每个信号量都有一个当前值，用于记录对应的资源可用数量。 
