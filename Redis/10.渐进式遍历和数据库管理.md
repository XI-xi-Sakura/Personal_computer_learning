

## 渐进式遍历


Redis 使用 scan 命令进行渐进式遍历键，进而解决直接使用 keys 获取键时可能出现的阻塞问题。

每次 scan 命令的时间复杂度是 O(1)，但是要完整地完成所有键的遍历，需要执行多次 scan。整个过程如下图所示。
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/fd8be4f3d7d44613bee6468c9ce57651.png)

- 首次 scan 从 0 开始。
- 当 scan 返回的下次位置为 0 时，遍历结束。

**SCAN**
以渐进式的方式进行键的遍历。
语法：

```sql
SCAN cursor [MATCH pattern] [COUNT count] [TYPE type]
```

命令有效版本：2.8.0 之后
时间复杂度：O(1)
返回值：**下一次 scan 的游标（cursor）以及本次得到的键**。
示例：

```sql
redis 127.0.0.1:6379> scan 0
1) "17"
2) 1) "key:12"
   2) "key:8"
   3) "key:4"
   4) "key:14"
   5) "key:16"
   6) "key:13"
   7) "key:15"
   8) "key:10"
   9) "key:3"
   10) "key:7"
   11) "key:1"
redis 127.0.0.1:6379> scan 17
1) "0"
2) 1) "key:5"
   2) "key:18"
   3) "key:0"
   4) "key:2"
   5) "key:19"
   6) "key:11"
   7) "key:6"
   8) "key:9"
   9) "key:11"
```

除了 scan 以外，Redis 面向哈希类型、集合类型、有序集合类型分别提供了 hscan、sscan、zscan 命令，它们的用法和 scan 基本类似，感兴趣的读者可以自行做扩展学习。

❗ 渐进性遍历 scan 虽然解决了阻塞的问题，但如果在遍历期间键有所变化（增加、修改、删除），可能导致遍历时键的重复遍历或者遗漏，这点务必在实际开发中考虑。



## 数据库管理

Redis 提供了几个面向 Redis 数据库的操作，分别是 dbsize、select、flushdb、flushall 命令，本机将通过具体的使用常见介绍这些命令。


### 切换数据库

```sql
select dbIndex
```

许多关系型数据库，例如 MySQL 支持在一个实例下有多个数据库存在的，但是与关系型数据库用字符来区分不同数据库名不同，**Redis 只是用数字作为多个数据库的实现**。

Redis 默认配置中是有 16 个数据库。select 0 操作会切换到第一个数据库，select 15 会切换到最后一个数据库。0 号数据库和 15 号数据库保存的数据是完全不冲突的(下图所示），即各种有各自的键值对。默认情况下，我们处于数据库 0。
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/affc4a75a428450c9ea7a7076246d4e3.png)


❗ Redis 中虽然支持多数据库，但随着版本的升级，其实不是特别建议使用多数据库特性。如果真的需要完全隔离的两套键值对，更好的做法是维护多个 Redis 实例，而不是在一个 Redis 实例中维护多数据库。这是因为本身 Redis 并没有为多数据库提供太多的特性，其次无论是否有多个数据库，Redis 都是使用单线程模型，所以彼此之间还是需要排队等待命令的执行。同时多数据库还会让开发、调试和运维工作变得复杂。所以实践中，**始终使用数据库 0 其实是一个很好的选择**。

### 清除数据库

`flushdb / flushall` 命令用于清除数据库，区别在于 flushdb 只清除当前数据库，flushall 会清楚所有数据库。
❗ 永远不要在线上环境执行清除数据的操作，除非你想体验一把“从删库到跑路”的操作。
 

